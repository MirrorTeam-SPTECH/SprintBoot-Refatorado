# =========================================================
# Portal Churras - Continuous Deployment (CD)
# =========================================================
# Deploy usando Self-Hosted Runner no AWS Academy
# O runner roda na EC2 JMeter e faz deploy via SSH
# =========================================================

name: Portal Churras CD

on:
  push:
    branches: [main]
  
  # Permite executar manualmente
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy Backend?'
        required: true
        default: true
        type: boolean
      deploy_frontend:
        description: 'Deploy Frontend?'
        required: true
        default: true
        type: boolean

env:
  APP_NAME: portalchurras
  
  # IPs das instÃ¢ncias (serÃ£o sobrescritos pelos secrets ou outputs do Terraform)
  BACKEND_1_IP: ${{ secrets.BACKEND_1_IP }}
  BACKEND_2_IP: ${{ secrets.BACKEND_2_IP }}
  FRONTEND_IP: ${{ secrets.FRONTEND_IP }}
  DATABASE_IP: ${{ secrets.DATABASE_IP }}
  CACHE_IP: ${{ secrets.CACHE_IP }}

jobs:
  # =========================================
  # Build
  # =========================================
  build:
    name: ğŸ”¨ Build
    runs-on: self-hosted
    
    outputs:
      backend_jar: ${{ steps.build-backend.outputs.jar_path }}
      frontend_dist: ${{ steps.build-frontend.outputs.dist_path }}
    
    steps:
      - name: ğŸ”„ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“‹ Verificar ambiente
        run: |
          echo "=========================================="
          echo "ğŸ–¥ï¸  Runner Info"
          echo "=========================================="
          echo "Hostname: $(hostname)"
          echo "User: $(whoami)"
          echo "PWD: $(pwd)"
          echo "=========================================="

      # =========================================
      # BUILD BACKEND
      # =========================================
      - name: â˜• Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: maven

      - name: ğŸ”¨ Build Backend
        id: build-backend
        run: |
          echo "ğŸ”¨ Compilando Backend..."
          chmod +x mvnw
          ./mvnw clean package -DskipTests -B -q
          
          JAR_PATH=$(ls target/*.jar | grep -v original | head -1)
          echo "âœ… JAR: $JAR_PATH"
          echo "jar_path=$JAR_PATH" >> $GITHUB_OUTPUT
          
          # Copiar JAR para diretÃ³rio de deploy
          mkdir -p /tmp/deploy
          cp $JAR_PATH /tmp/deploy/app.jar
          echo "âœ… Backend build concluÃ­do!"

      # =========================================
      # BUILD FRONTEND
      # =========================================
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ”¨ Build Frontend
        id: build-frontend
        run: |
          echo "âš ï¸ Frontend estÃ¡ em repositÃ³rio separado (Mirror-React)"
          echo "Pulando build do frontend neste workflow..."
          mkdir -p /tmp/deploy/frontend
          echo "dist_path=/tmp/deploy/frontend" >> $GITHUB_OUTPUT

  # =========================================
  # Deploy Backend
  # =========================================
  deploy-backend:
    name: ğŸš€ Deploy Backend
    needs: build
    runs-on: self-hosted
    if: ${{ github.event.inputs.deploy_backend != 'false' }}
    
    strategy:
      matrix:
        backend: [1, 2]
      fail-fast: false
    
    steps:
      - name: ğŸ”„ Checkout (para scripts)
        uses: actions/checkout@v4

      - name: ğŸ“‹ Determinar IP do Backend
        id: get-ip
        run: |
          if [ "${{ matrix.backend }}" == "1" ]; then
            echo "ip=${{ env.BACKEND_1_IP }}" >> $GITHUB_OUTPUT
          else
            echo "ip=${{ env.BACKEND_2_IP }}" >> $GITHUB_OUTPUT
          fi

      - name: ğŸš€ Deploy no Backend ${{ matrix.backend }}
        env:
          BACKEND_IP: ${{ steps.get-ip.outputs.ip }}
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          DB_HOST: ${{ env.DATABASE_IP }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          REDIS_HOST: ${{ env.CACHE_IP }}
          RABBITMQ_HOST: ${{ env.CACHE_IP }}
          RABBITMQ_USER: ${{ secrets.RABBITMQ_USER }}
          RABBITMQ_PASSWORD: ${{ secrets.RABBITMQ_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          echo "ğŸš€ Deploying to Backend ${{ matrix.backend }} ($BACKEND_IP)..."
          
          # Configurar SSH key
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Adicionar host conhecido
          ssh-keyscan -H $BACKEND_IP >> ~/.ssh/known_hosts 2>/dev/null
          
          # Copiar JAR
          echo "ğŸ“¦ Copiando JAR..."
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            /tmp/deploy/app.jar \
            ec2-user@$BACKEND_IP:/tmp/app.jar
          
          # Executar deploy no servidor
          echo "âš™ï¸ Executando deploy..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ec2-user@$BACKEND_IP 'bash -s' << 'ENDSSH'
            set -e
            
            echo "ğŸ›‘ Parando aplicaÃ§Ã£o atual..."
            sudo pkill -f 'java.*app.jar' || true
            sleep 5
            
            echo "ğŸ“ Preparando diretÃ³rios..."
            sudo mkdir -p /app/config /app/backup /app/logs
            sudo chown -R ec2-user:ec2-user /app
            
            # Backup do JAR anterior
            if [ -f /app/app.jar ]; then
              cp /app/app.jar /app/backup/app.jar.$(date +%Y%m%d%H%M%S)
            fi
            
            # Mover novo JAR
            cp /tmp/app.jar /app/app.jar
            
            echo "ğŸš€ Iniciando aplicaÃ§Ã£o..."
            cd /app
            
            # Exportar variÃ¡veis de ambiente
            export DB_URL="jdbc:postgresql://10.0.10.234:5432/portalchurras"
            export DB_USERNAME="admin"
            export DB_PASSWORD='Admin123!@#'
            export REDIS_HOST="10.0.10.106"
            export REDIS_PORT="6379"
            export RABBITMQ_HOST="10.0.10.106"
            export RABBITMQ_PORT="5672"
            export RABBITMQ_USER="admin"
            export RABBITMQ_PASSWORD='Admin123!@#'
            export JWT_SECRET="portalchurras-secret-key-2024-very-long-and-secure"
            
            # Iniciar aplicaÃ§Ã£o com variÃ¡veis (usando aspas simples para proteger caracteres especiais)
            nohup java -Xmx512m -Xms256m \
              -Dspring.profiles.active=prod \
              -Dspring.datasource.url="$DB_URL" \
              -Dspring.datasource.username="admin" \
              -Dspring.datasource.password='Admin123!@#' \
              -Dspring.redis.host="$REDIS_HOST" \
              -Dspring.redis.port="$REDIS_PORT" \
              -Dspring.rabbitmq.host="$RABBITMQ_HOST" \
              -Dspring.rabbitmq.port="$RABBITMQ_PORT" \
              -Dspring.rabbitmq.username="admin" \
              -Dspring.rabbitmq.password='Admin123!@#' \
              -Djwt.secret="$JWT_SECRET" \
              -jar /app/app.jar > /app/logs/backend.log 2>&1 &
            
            echo "â³ Aguardando inicializaÃ§Ã£o..."
            sleep 60
            
            # Health check
            for i in $(seq 1 15); do
              if pgrep -f 'java.*app.jar' > /dev/null; then
                if ss -tlnp | grep -q ':8080'; then
                  echo "âœ… Backend estÃ¡ rodando na porta 8080!"
                  tail -50 /app/logs/backend.log
                  exit 0
                fi
              fi
              echo "Tentativa $i/15..."
              sleep 10
            done
            
            echo "âŒ Health check falhou"
            tail -100 /app/logs/backend.log
            exit 1
          ENDSSH
          
          echo "âœ… Deploy no Backend ${{ matrix.backend }} concluÃ­do!"

  # =========================================
  # Deploy Frontend
  # =========================================
  deploy-frontend:
    name: ğŸ¨ Deploy Frontend
    needs: build
    runs-on: self-hosted
    if: ${{ github.event.inputs.deploy_frontend != 'false' }}
    
    steps:
      - name: ğŸ”„ Checkout (para scripts)
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy no Frontend
        env:
          FRONTEND_IP: ${{ env.FRONTEND_IP }}
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          echo "ğŸš€ Deploying Frontend to $FRONTEND_IP..."
          
          # Configurar SSH key
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Adicionar host conhecido
          ssh-keyscan -H $FRONTEND_IP >> ~/.ssh/known_hosts 2>/dev/null
          
          # Compactar frontend para transferÃªncia
          echo "ğŸ“¦ Compactando frontend..."
          cd /tmp/deploy
          tar -czf frontend.tar.gz -C frontend .
          
          # Copiar para o servidor
          echo "ğŸ“¤ Transferindo arquivos..."
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            frontend.tar.gz \
            ec2-user@$FRONTEND_IP:/tmp/frontend.tar.gz
          
          # Executar deploy no servidor
          echo "âš™ï¸ Executando deploy..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ec2-user@$FRONTEND_IP << 'ENDSSH'
            set -e
            
            echo "ğŸ“ Preparando diretÃ³rios..."
            sudo mkdir -p /app/html
            sudo mkdir -p /app/backup
            
            # Backup do frontend anterior
            if [ -d /app/html ] && [ "$(ls -A /app/html)" ]; then
              sudo tar -czf /app/backup/html.$(date +%Y%m%d%H%M%S).tar.gz -C /app/html .
            fi
            
            # Extrair novo frontend
            echo "ğŸ“‚ Extraindo arquivos..."
            sudo rm -rf /app/html/*
            sudo tar -xzf /tmp/frontend.tar.gz -C /app/html
            sudo chown -R nginx:nginx /app/html 2>/dev/null || sudo chown -R ec2-user:ec2-user /app/html
            
            # Recarregar Nginx (se estiver rodando)
            if systemctl is-active --quiet nginx; then
              echo "ğŸ”„ Recarregando Nginx..."
              sudo nginx -t && sudo systemctl reload nginx
            elif docker ps | grep -q nginx; then
              echo "ğŸ”„ Recarregando Nginx (Docker)..."
              docker exec $(docker ps -q -f name=nginx) nginx -s reload || true
            fi
            
            # Health check
            echo "ğŸ¥ Verificando..."
            if curl -sf http://localhost/health > /dev/null 2>&1 || curl -sf http://localhost/ > /dev/null 2>&1; then
              echo "âœ… Frontend estÃ¡ saudÃ¡vel!"
            else
              echo "âš ï¸ Health check nÃ£o passou, mas arquivos foram atualizados"
            fi
            
            rm /tmp/frontend.tar.gz
          ENDSSH
          
          echo "âœ… Deploy do Frontend concluÃ­do!"

  # =========================================
  # VerificaÃ§Ã£o Final
  # =========================================
  verify:
    name: âœ… VerificaÃ§Ã£o
    needs: [deploy-backend, deploy-frontend]
    runs-on: self-hosted
    if: always() && (needs.deploy-backend.result == 'success' || needs.deploy-frontend.result == 'success')
    
    steps:
      - name: ğŸ“Š Status do Deploy
        run: |
          echo "=========================================="
          echo "ğŸ“Š Resumo do Deploy"
          echo "=========================================="
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Timestamp: $(date)"
          echo ""
          echo "Backend 1: ${{ env.BACKEND_1_IP }}"
          echo "Backend 2: ${{ env.BACKEND_2_IP }}"
          echo "Frontend: ${{ env.FRONTEND_IP }}"
          echo "=========================================="

      - name: ğŸ¥ Health Check - Backend 1
        if: ${{ env.BACKEND_1_IP != '' }}
        continue-on-error: true
        run: |
          echo "Verificando Backend 1..."
          curl -sf http://${{ env.BACKEND_1_IP }}:8080/actuator/health && echo "âœ… OK" || echo "âŒ FALHOU"

      - name: ğŸ¥ Health Check - Backend 2
        if: ${{ env.BACKEND_2_IP != '' }}
        continue-on-error: true
        run: |
          echo "Verificando Backend 2..."
          curl -sf http://${{ env.BACKEND_2_IP }}:8080/actuator/health && echo "âœ… OK" || echo "âŒ FALHOU"

      - name: ğŸ¥ Health Check - Frontend
        if: ${{ env.FRONTEND_IP != '' }}
        continue-on-error: true
        run: |
          echo "Verificando Frontend..."
          curl -sf http://${{ env.FRONTEND_IP }}/ && echo "âœ… OK" || echo "âŒ FALHOU"

      - name: ğŸ“ Salvar log do deploy
        run: |
          mkdir -p ~/deploys
          cat > ~/deploys/last-deploy.json << EOF
          {
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "actor": "${{ github.actor }}",
            "timestamp": "$(date -Iseconds)",
            "backend_status": "${{ needs.deploy-backend.result }}",
            "frontend_status": "${{ needs.deploy-frontend.result }}"
          }
          EOF
          cat ~/deploys/last-deploy.json
